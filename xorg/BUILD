#!/bin/bash
set -Eeuo pipefail

# NOTE: adding / removing the variables / modifying the name of variables is not allowed in this script

# Available local variables:
#  - variables defined in custom_build
#  - ${target_root_prefix_without_pkgname}: ${target_root_with_pkgname} is the output directory generated by the building process. i.e. the staging area for this package manager. Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#  - ${sources_root}: the suggested root directory of the source directory
setup() {

# TODO: please fill in the variables for this package

# [REQUIRED, NON-EMPTY, SEMVER]
pkg_version="7.0"
# [REQUIRED, NON-EMPTY, NO-SPACE]
pkg_name="xorg"
# [OPTIONAL, seperated by commas, NO-SPACE]. e.g., pkgname1>=0.5,pkgname2==1.0.0,pkgname2<2.0.0,pkgname3
pkg_deps="fontconfig>=2.0"
# [OPTIONAL, seperated by commas, NO-SPACE]
pkg_build_deps="fontconfig>=2.0,freetype>2.0,libncursesw>6.0,libreadline>8.0,icu>70.0,libexpat>2.0,libxml2>2.0,libiconv>1.0"
########### At Least ONE is REQUIRED ##############
# [OPTIONAL, VALID-URL]
pkg_source_url="https://www.x.org/pub/individual/lib/"
# [OPTIONAL, VALID-URL]
pkg_release_url=""
###################################################
pkg_license="Apache-2.0"
# [REQUIRED, NON-EMPTY, seperated by commas, NO-SPACE]. e.g., x86_64,aarch64,arm,riscv
pkg_support_archs="x86_64,aarch64,arm"
# [REQUIED, NON-EMPTY]
# choose one: "autotools" (configure and make), "cmake", "meson", "pure-python", "custom"
# NOTE:
#  - "pure-python" is ONLY valid for those packages without ANY native package dependency.
#  - "custom" will skip the default build process
pkg_build_type="custom"
# [OPTIONAL]
pkg_build_parallism=""

####### build type related (all OPTIONAL) #######

pkg_build_autotools_extra_configure_flags=""
# fill in a relative path to the ${current_source_root} (defined below)
pkg_build_autotools_bootstrap_script=""
pkg_build_autotools_suffix_configure_flags=""
pkg_build_autotools_configure_dir=""

pkg_build_cmake_extra_cmake_flags=""
pkg_build_cmake_extra_cmake_prefix_path=""
pkg_build_cmake_extra_cflags=""
# NOTE: C preprocessor not CXX
pkg_build_cmake_extra_cppflags=""
pkg_build_cmake_extra_ldflags=""
pkg_build_cmake_extra_cmake_findroot_path=""

# fill in a absolute path
pkg_build_meson_cross_file=""
pkg_build_meson_extra_meson_flags=""
pkg_build_meson_extra_cflags=""
pkg_build_meson_extra_ldflags=""
pkg_build_meson_extra_cmake_prefix_path=""
pkg_build_meson_extra_cmake_findroot_path=""

}


################# Hooks #################
# NOTE:
#  1. not using relative path in hooks
#  2. not using $PWD, pwd, cd here. You can ONLY use pushd to change your working directory and you are responsible to use popd to restore the old one before the hook returns
#  3. not creating global variables in hooks (except for `custom_build`)
#  4. global config variables (capitalized) in setup.sh (like OHOS_LIBDIR, OHOS_CPU, ...) is available in hooks
#  5. important cross-compiling variables will be reset after building each package (like CFLAGS, CXXFLAGS, LDFLAGS, CC, CXX, AR, PKG_CONFIG_LIBDIR, ...)
#  6. you can use helper functions in setup.sh
#  7. you can define your own function here but you can only use it for this package. If you want to define a function for building process of multiple packages, you should modify the setup.sh
#  8. you are responsible to handle all the failures in hooks (commands may continue if you not deal with it)
# 
# Available global variables:
#  - ${native_project_root}: the parent directory of setup.sh
#  - ${native_sources_root}: root for native sources (staging area)
#  - cross-compiling variables (reset for each package): CC, CXX, AR, CFLAGS, PKG_CONFIG_*, ...
#  - global configurations: OHOS_ARCH, OHOS_CPU, OHOS_LIBDIR, PATCH_FILE_ROOT, MESON_CROSS_ROOT, HOST_SYSROOT, ... (see setup.sh)
# Available local variables (except for native_env_hook):
#  - ${current_source_url}: user configured `pkg_source_url` above (in `setup()`)
#  - ${current}: the location (directory) of this script
#  - ${sources_root}: the suggested root directory of the source directory
#  - ${current_source_root}: the current source directory to be compiled
#  - ${target_root_with_pkgname}: output directory generated by the building process. i.e. the staging area for this package manager
#  - ${target_root_prefix_without_pkgname}: Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#########################################

# Hook: called before setup.sh is sourced
# NOTE:
#  - failure in this function will terminate this script immediately
#  - you can NOT use local variables defined above. you can only use ${native_project_root}, ${native_sources_root} built by builder.sh
native_env_hook() {
	:
}

# Hook: customize downloading source process. called when pacakge manager is downloading the source.
# 	Set _custom_download_source_continue to "true" (default) to continue normal downloading process after return, otherwise not.
# NOTE: you need to make sure the source locates in ${current_source_root}
# 	if you set _custom_download_source_continue="false" caz default build process will use
custom_download_source() {

	if [ -f "${current_source_root}/XORG_DOWNLOADED" ]; then
		return 0
	fi

	mkdir -p ${current_source_root}
	pushd ${current_source_root}
	
	wget_source https://www.x.org/pub/individual/util/util-macros-1.20.2.tar.xz "${current_source_root}/util-macros"
	wget_source https://xorg.freedesktop.org/archive/individual/proto/xcb-proto-1.17.0.tar.xz "${current_source_root}/xcb-proto"
	wget_source https://xorg.freedesktop.org/archive/individual/proto/xorgproto-2024.1.tar.xz "${current_source_root}/xorgproto"
	wget_source https://www.x.org/pub/individual/lib/libXau-1.0.12.tar.xz "${current_source_root}/libXau"
	wget_source https://xorg.freedesktop.org/archive/individual/lib/libxcb-1.17.0.tar.xz "${current_source_root}/libxcb"
	
	# start xlibs

	XLIBS_MD5_FN=lib-7.md5
	XPROTOS_MD5_FN=proto-7.md5
	# necessary as a global var
	LIBNAME_LIST=libnames.list

	mkdir -p xlibs xprotos
	rm -f xlibs/$LIBNAME_LIST xprotos/$LIBNAME_LIST
	
	pushd xlibs

cat > $XLIBS_MD5_FN << "EOF"
6ad67d4858814ac24e618b8072900664  xtrans-1.6.0.tar.xz
146d770e564812e00f97e0cbdce632b7  libX11-1.8.12.tar.xz
e59476db179e48c1fb4487c12d0105d1  libXext-1.3.6.tar.xz
c5cc0942ed39c49b8fcd47a427bd4305  libFS-1.0.10.tar.xz
d1ffde0a07709654b20bada3f9abdd16  libICE-1.1.2.tar.xz
3aeeea05091db1c69e6f768e0950a431  libSM-1.2.6.tar.xz
ec09c90a1cfd2c0630321d366a5e7203  libXScrnSaver-1.2.5.tar.xz
9acd189c68750b5028cf120e53c68009  libXt-1.3.1.tar.xz
85edefb7deaad4590a03fccba517669f  libXmu-1.2.1.tar.xz
05b5667aadd476d77e9b5ba1a1de213e  libXpm-3.5.17.tar.xz
2a9793533224f92ddad256492265dd82  libXaw-1.0.16.tar.xz
baa39ada682dd524491a165bb0dfc708  libXfixes-6.0.2.tar.xz
af0a5f0abb5b55f8411cd738cf0e5259  libXcomposite-0.4.6.tar.xz
4c54dce455d96e3bdee90823b0869f89  libXrender-0.9.12.tar.xz
5ce55e952ec2d84d9817169d5fdb7865  libXcursor-1.2.3.tar.xz
ca55d29fa0a8b5c4a89f609a7952ebf8  libXdamage-1.1.6.tar.xz
8816cc44d06ebe42e85950b368185826  libfontenc-1.1.8.tar.xz
66e03e3405d923dfaf319d6f2b47e3da  libXfont2-2.0.7.tar.xz
d378be0fcbd1f689f9a132e0d642bc4b  libXft-2.3.9.tar.xz
# 95a960c1692a83cc551979f7ffe28cf4  libXi-1.8.2.tar.xz
# 228c877558c265d2f63c56a03f7d3f21  libXinerama-1.1.5.tar.xz
24e0b72abe16efce9bf10579beaffc27  libXrandr-1.5.4.tar.xz
5014282a08b54ec0edfa73c5cf9ae2c1  libXres-1.2.3.tar.xz
# b62dc44d8e63a67bb10230d54c44dcb7  libXtst-1.2.5.tar.xz
8a26503185afcb1bbd2c65e43f775a67  libXv-1.0.13.tar.xz
a90a5f01102dc445c7decbbd9ef77608  libXvMC-1.0.14.tar.xz
74d1acf93b83abeb0954824da0ec400b  libXxf86dga-1.1.6.tar.xz
d3db4b6dc924dc151822f5f7e79ae873  libXxf86vm-1.1.6.tar.xz
# 57c7efbeceedefde006123a77a7bc825  libpciaccess-0.18.1.tar.xz
229708c15c9937b6e5131d0413474139  libxkbfile-1.1.3.tar.xz
9805be7e18f858bed9938542ed2905dc  libxshmfence-1.3.3.tar.xz
53b72ce969745f8d3e41175d6549ce0b  libXpresent-1.0.2.tar.xz
EOF

	grep -v '^#' $XLIBS_MD5_FN | awk '{print $2}' | wget -i- -c \
	    -B https://www.x.org/pub/individual/lib/ &&
	md5sum -c $XLIBS_MD5_FN
	
	local libf_list=$(grep -v '^#' $XLIBS_MD5_FN | awk '{print $2}')
	local tf
	for tf in $libf_list; do
		name_with_version="${tf%%.tar*}"
		lib_name="${name_with_version%-*}"
		# version="${name_with_version##*-}"
		tar -xpvf $tf
		mv $name_with_version $lib_name
		rm $tf
		echo $lib_name >> $LIBNAME_LIST
	done
	
	popd

	# proto headers
	
	pushd xprotos

cat > $XPROTOS_MD5_FN << "EOF"
# 1a05fb01fa1d5198894c931cf925c025  bigreqsproto-1.1.2.tar.bz2
# 98482f65ba1e74a08bf5b056a4031ef0  compositeproto-0.4.2.tar.bz2
# 998e5904764b82642cc63d97b4ba9e95  damageproto-1.2.1.tar.bz2
# 4ee175bbd44d05c34d43bb129be5098a  dmxproto-2.3.1.tar.bz2
b2721d5d24c04d9980a0c6540cb5396a  dri2proto-2.8.tar.bz2
# a3d2cbe60a9ca1bf3aea6c93c817fee3  dri3proto-1.0.tar.bz2
# e7431ab84d37b2678af71e29355e101d  fixesproto-5.0.tar.bz2
# 36934d00b00555eaacde9f091f392f97  fontsproto-2.1.3.tar.bz2
5565f1b0facf4a59c2778229c1f70d10  glproto-1.4.17.tar.bz2
b290a463af7def483e6e190de460f31a  inputproto-2.3.2.tar.bz2
94afc90c1f7bef4a27fdd59ece39c878  kbproto-1.0.7.tar.bz2
# 92f9dda9c870d78a1d93f366bcb0e6cd  presentproto-1.1.tar.bz2
a46765c8dcacb7114c821baf0df1e797  randrproto-1.5.0.tar.bz2
# 1b4e5dede5ea51906f1530ca1e21d216  recordproto-1.14.2.tar.bz2
a914ccc1de66ddeb4b611c6b0686e274  renderproto-0.11.1.tar.bz2
# cfdb57dae221b71b2703f8e2980eaaf4  resourceproto-1.2.0.tar.bz2
# edd8a73775e8ece1d69515dd17767bfb  scrnsaverproto-1.2.2.tar.bz2
# fe86de8ea3eb53b5a8f52956c5cd3174  videoproto-2.3.3.tar.bz2
# 5f4847c78e41b801982c8a5e06365b24  xcmiscproto-1.2.2.tar.bz2
70c90f313b4b0851758ef77b95019584  xextproto-7.3.0.tar.bz2
# 120e226ede5a4687b25dd357cc9b8efe  xf86bigfontproto-1.2.0.tar.bz2
# a036dc2fcbf052ec10621fd48b68dbb1  xf86dgaproto-2.1.tar.bz2
1d716d0dac3b664e5ee20c69d34bc10e  xf86driproto-2.1.1.tar.bz2
e793ecefeaecfeabd1aed6a01095174e  xf86vidmodeproto-2.3.1.tar.bz2
# 9959fe0bfb22a0e7260433b8d199590a  xineramaproto-1.2.1.tar.bz2
16791f7ca8c51a20608af11702e51083  xproto-7.0.31.tar.bz2
EOF

	grep -v '^#' $XPROTOS_MD5_FN | awk '{print $2}' | wget -i- -c \
	    -B https://www.x.org/pub/individual/proto/ &&
	md5sum -c $XPROTOS_MD5_FN
	
	local protf_list=$(grep -v '^#' $XPROTOS_MD5_FN | awk '{print $2}')
	for tf in $protf_list; do
		name_with_version="${tf%%.tar*}"
		proto_name="${name_with_version%-*}"
		# version="${name_with_version##*-}"
		tar -xpvf $tf
		mv $name_with_version $proto_name
		rm $tf
		echo $proto_name >> $LIBNAME_LIST
	done
	
	popd

	touch XORG_DOWNLOADED

	popd

	_custom_download_source_continue=false
}

############### DO NOT MODIFY THIS PART #################
if [ "x${LOAD_NATIVE_HOOK_ONLY:-}" = "xtrue" ]; then
	return 0
fi
#########################################################

# Hook: called before entering build dir
prebuilt_patch_hook() {
	:
}

# Hook: same as `prebuilt_patch_hook` but executed once if the source directory is not changed (mark file PATCHED)
# NOTE: it will be executed BEFORE prebuilt_patch_hook
prebuilt_patch_once_hook() {
	:
}

# Hook: customize building process.
# 	Set _custom_build_continue to "true" (default) to continue normal building process after return, otherwise not.
# NOTE:
#  - You can set cross-compiling related global variables here (like CFLAGS)
#  - postbuilt_hook will still be called after custom_build set _custom_build_continue="false"
custom_build() {

	setup_pycrossenv
	
	XORG_PREFIX=${target_root_with_pkgname}
	# XORG_CONFIG="--sysconfdir=/etc --localstatedir=/data --disable-static"
	XORG_CONFIG="--disable-static"
	PKG_CONFIG_LIBDIR="${XORG_PREFIX}/share/pkgconfig:$PKG_CONFIG_LIBDIR"

	rm -rf ${XORG_PREFIX}
	mkdir -p ${XORG_PREFIX}

	pushd ${current_source_root}

	build_makeproj_with_deps "util-macros" "" "$XORG_CONFIG"
	mv_xorg_comp_to_prefix "util-macros"

	PYTHON=${BUILD_PYTHON} build_makeproj_with_deps "xcb-proto" "" "$XORG_CONFIG"
	mv_xorg_comp_to_prefix "xcb-proto"

	reset_meson $MESON_CROSS_FILE_BASE
	# deps: util-macros
	build_mesonproj_with_deps "xorgproto" "$pkg_name" "$MESON_CROSS_FILE_BASE"
	mv_xorg_comp_to_prefix "xorgproto"
	# rename doc
	mv -v $XORG_PREFIX/share/doc/xorgproto{,-2024.1}

	# deps: xorgproto
	build_makeproj_with_deps "libXau" "$pkg_name" "$XORG_CONFIG"
	mv_xorg_comp_to_prefix "libXau"

	# deps: libXau, xcp-proto (fake deps xorg)
	build_makeproj_with_deps "libxcb" "$pkg_name" "$XORG_CONFIG --without-doxygen --docdir=\${datadir}/doc/libxcb-1.17.0"
	mv_xorg_comp_to_prefix "libxcb"

	local pkg

	pushd xprotos
	for pkg in $(cat $LIBNAME_LIST); do
		info "building xorg protocol component: $pkg"
	
		# rubbish 2009 xproto. Fuck xorg
		case $pkg in
			xproto|xextproto|renderproto|dri2proto|xf86driproto|xf86vidmodeproto)
				# configure it manually
				# not support aarch64 (${OHOS_CPU}), not support musl. Idiot
				_xproto_arch=${OHOS_CPU}
				if [ "${OHOS_CPU}" == "aarch64" ]; then
					_xproto_arch=arm
				fi
				pushd $pkg
				./configure --prefix=${target_root_prefix_without_pkgname} \
					--libdir=${target_root_prefix_without_pkgname}/${OHOS_LIBDIR} \
					--target=${_xproto_arch}-linux-gnu \
					--host=${_xproto_arch}-linux-gnu \
					--build=${BUILD_PLATFORM_TRIPLET} \
					${XORG_CONFIG}
				make install
				popd
				mv ${target_root_prefix_without_pkgname} $(get_pkg_dst_dir $pkg)
				mv_xorg_comp_to_prefix "$pkg"
				continue
			;;
		esac
		build_makeproj_with_deps "$pkg" "$pkg_name" "$XORG_CONFIG"
		mv_xorg_comp_to_prefix "$pkg"
	done
	popd

	pushd xlibs
	# deps: libxcb (fake deps), fontconfig
	# note: freetype, readline, ncurses use special header dir
	CFLAGS="-I$(get_pkg_dst_dir freetype)/include/freetype2 -I$(get_pkg_dst_dir libncursesw)/include/ncursesw -I$(get_pkg_dst_dir libreadline)/include/readline $CFLAGS"
	CXXFLAGS=$CFLAGS
	_xlibs_deps="$pkg_name $(get_pkg_names_from_deps $pkg_build_deps)"
	for pkg in $(cat $LIBNAME_LIST); do
		info "building xorg lib component: $pkg"
		pkg_flags="$XORG_CONFIG --enable-malloc0returnsnull=no"
		case $pkg in
			libXfont2)
				pkg_flags="$pkg_flags --disable-devel-docs"
			;;
			libXt)
				#pkg_flags="$pkg_flags --with-appdefaultdir=/etc/X11/app-defaults"
			;;
			libXpm)
				pkg_flags="$pkg_flags --disable-open-zfile"
			;;
			libpciaccess*)
				error "OHOS doesn't support X11 pci access"
				# exit 1
				reset_meson "$MESON_CROSS_FILE_BASE"
				build_mesonproj_with_deps "$pkg" "$_xlibs_deps" "$MESON_CROSS_FILE_BASE"
				mv_xorg_comp_to_prefix "$pkg"
				continue
			;;
			*)
				# do nothing special
			;;
		esac
		build_makeproj_with_deps "$pkg" "$_xlibs_deps" "$pkg_flags"
		mv_xorg_comp_to_prefix "$pkg"
	done
	popd

	popd

	destroy_pycrossenv

	_custom_build_continue=false
}

# Hook: called after leaving build dir (staging area ${target_root_with_pkgname} is generated)
postbuilt_hook() {
	:
}

################ self-defined functions (local) goes below ################

mv_xorg_comp_to_prefix() {
	local comp_name=$1
	local original_dst=$(get_pkg_dst_dir $comp_name)

	cp -r $original_dst/* ${XORG_PREFIX}/
	rm -rf $original_dst
	# fix patching for Xorg libs like util-macros (pc in share dir)
	patch_libdir_origin "xorg" "" "" "${XORG_PREFIX}/share"
	if [ -d "${XORG_PREFIX}/${OHOS_LIBDIR}" ]; then
		patch_libdir_origin "xorg"
	fi
}

