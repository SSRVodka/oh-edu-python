#!/bin/bash
set -Eeuo pipefail

# NOTE: adding / removing the variables / modifying the name of variables is not allowed in this script

# Available local variables:
#  - variables defined in custom_build
#  - ${target_root_prefix_without_pkgname}: ${target_root_with_pkgname} is the output directory generated by the building process. i.e. the staging area for this package manager. Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#  - ${sources_root}: the suggested root directory of the source directory
setup() {

# TODO: please fill in the variables for this package

# [REQUIRED, NON-EMPTY, SEMVER]
pkg_version="21.1.4"
# [REQUIRED, NON-EMPTY, NO-SPACE]
pkg_name="llvm"
# [OPTIONAL, seperated by commas, NO-SPACE]. e.g., pkgname1>=0.5,pkgname2==1.0.0,pkgname2<2.0.0,pkgname3
pkg_deps=""
# [OPTIONAL, seperated by commas, NO-SPACE]
pkg_build_deps=""
########### At Least ONE is REQUIRED ##############
# [OPTIONAL, VALID-URL]
pkg_source_url="https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-21.1.4.zip"
# [OPTIONAL, VALID-URL]
pkg_release_url=""
###################################################
pkg_license="Apache-2.0"
# [REQUIRED, NON-EMPTY, seperated by commas, NO-SPACE]. e.g., x86_64,aarch64,arm,riscv
pkg_support_archs="x86_64,aarch64,arm"
# [REQUIED, NON-EMPTY]
# choose one: "autotools" (configure and make), "cmake", "meson", "pure-python", "custom"
# NOTE:
#  - "pure-python" is ONLY valid for those packages without ANY native package dependency.
#  - "custom" will skip the default build process
pkg_build_type="custom"
# [OPTIONAL]
pkg_build_parallism=""

####### build type related (all OPTIONAL) #######

pkg_build_autotools_extra_configure_flags=""
# fill in a relative path to the ${current_source_root} (defined below)
pkg_build_autotools_bootstrap_script=""
pkg_build_autotools_suffix_configure_flags=""
pkg_build_autotools_configure_dir=""

pkg_build_cmake_extra_cmake_flags=""
pkg_build_cmake_extra_cmake_prefix_path=""
pkg_build_cmake_extra_cflags=""
# NOTE: C preprocessor not CXX
pkg_build_cmake_extra_cppflags=""
pkg_build_cmake_extra_ldflags=""
pkg_build_cmake_extra_cmake_findroot_path=""

# fill in a relative path to this script
pkg_build_meson_cross_file=""
pkg_build_meson_extra_meson_flags=""
pkg_build_meson_extra_cflags=""
pkg_build_meson_extra_ldflags=""
pkg_build_meson_extra_cmake_prefix_path=""
pkg_build_meson_extra_cmake_findroot_path=""

}


################# Hooks #################
# NOTE:
#  1. not using relative path in hooks
#  2. not using $PWD, pwd, cd here. You can ONLY use pushd to change your working directory and you are responsible to use popd to restore the old one before the hook returns
#  3. not creating global variables in hooks (except for `custom_build`)
#  4. global config variables (capitalized) in setup.sh (like OHOS_LIBDIR, OHOS_CPU, ...) is available in hooks
#  5. important cross-compiling variables will be reset after building each package (like CFLAGS, CXXFLAGS, LDFLAGS, CC, CXX, AR, PKG_CONFIG_LIBDIR, ...)
#  6. you can use helper functions in setup.sh
#  7. you can define your own function here but you can only use it for this package. If you want to define a function for building process of multiple packages, you should modify the setup.sh
#  8. you are responsible to handle all the failures in hooks (commands may continue if you not deal with it)
# 
# Available global variables:
#  - ${native_project_root}: the parent directory of setup.sh
#  - ${native_sources_root}: root for native sources (staging area)
#  - cross-compiling variables (reset for each package): CC, CXX, AR, CFLAGS, PKG_CONFIG_*, ...
#  - global configurations: OHOS_ARCH, OHOS_CPU, OHOS_LIBDIR, PATCH_FILE_ROOT, MESON_CROSS_ROOT, HOST_SYSROOT, ... (see setup.sh)
# Available local variables (except for native_env_hook):
#  - ${current_source_url}: user configured `pkg_source_url` above (in `setup()`)
#  - ${current}: the location (directory) of this script
#  - ${sources_root}: the suggested root directory of the source directory
#  - ${current_source_root}: the current source directory to be compiled
#  - ${target_root_with_pkgname}: output directory generated by the building process. i.e. the staging area for this package manager
#  - ${target_root_prefix_without_pkgname}: Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#########################################

# Hook: called before setup.sh is sourced
# NOTE:
#  - failure in this function will terminate this script immediately
#  - you can NOT use local variables defined above. you can only use ${native_project_root}, ${native_sources_root} built by builder.sh
native_env_hook() {
	:
}

# Hook: customize downloading source process. called when pacakge manager is downloading the source.
# 	Set _custom_download_source_continue to "true" (default) to continue normal downloading process after return, otherwise not.
# NOTE: you need to make sure the source locates in ${current_source_root}
# 	if you set _custom_download_source_continue="false" caz default build process will use
custom_download_source() {
	_custom_download_source_continue=true
}

############### DO NOT MODIFY THIS PART #################
if [ "x${LOAD_NATIVE_HOOK_ONLY:-}" = "xtrue" ]; then
	return 0
fi
#########################################################

# Hook: called before entering build dir
prebuilt_patch_hook() {
	# patch for OHOS
	sed -i '/__OPENHARMONY__/! s/^\(#if defined(__ANDROID__)\)\(.*\)$/\1 || defined(__OPENHARMONY__)\2/' \
		${current_source_root}/openmp/runtime/src/kmp.h
	sed -i '\|__OPENHARMONY__|! s|^\(#if defined(__x86_64__) \&\& defined(__ELF__) \&\& defined(__linux__)\)\(.*\)$|\1 \&\& !defined(__OPENHARMONY__)\2|g' \
		${current_source_root}/llvm/tools/llvm-rtdyld/llvm-rtdyld.cpp
}

# Hook: same as `prebuilt_patch_hook` but executed once if the source directory is not changed (mark file PATCHED)
# NOTE: it will be executed BEFORE prebuilt_patch_hook
prebuilt_patch_once_hook() {
	:
}

# Hook: customize building process.
# 	Set _custom_build_continue to "true" (default) to continue normal building process after return, otherwise not.
# NOTE:
#  - You can set cross-compiling related global variables here (like CFLAGS)
#  - postbuilt_hook will still be called after custom_build set _custom_build_continue="false"
custom_build() {

	# remove --target
	CC="${OHOS_SDK}/native/llvm/bin/clang"
	CXX="${OHOS_SDK}/native/llvm/bin/clang++"
	CFLAGS="-D__OPENHARMONY__ -D__MUSL__"
	CXXFLAGS=$CFLAGS
	CPPFLAGS="-D__OPENHARMONY__ -D__MUSL__"
	LDFLAGS=""

	local SYSROOT="$HOST_SYSROOT"
	local TARGET=${OHOS_CPU}-linux-ohos
	local EXT_TOOLCHAIN_ROOT=${OHOS_SDK}/native/llvm

	local COMMON_LINKER_FLAGS="--target=${TARGET} -fuse-ld=lld -Wl,--sysroot=${HOST_SYSROOT} -L${HOST_SYSROOT}/usr/lib/${TARGET}"

	# generated runtime cmake config
cat - <<EOF > ${current_source_root}/$TARGET-clang.cmake
set(CMAKE_SYSTEM_NAME OHOS)
set(CMAKE_SYSROOT "$SYSROOT")
set(CMAKE_C_COMPILER_TARGET $TARGET)
set(CMAKE_CXX_COMPILER_TARGET $TARGET)
set(CMAKE_ASM_COMPILER_TARGET $TARGET)
set(CMAKE_C_FLAGS_INIT "$CFLAGS")
set(CMAKE_CXX_FLAGS_INIT "$CFLAGS")
set(CMAKE_EXE_LINKER_FLAGS "$COMMON_LINKER_FLAGS")
set(CMAKE_SHARED_LINKER_FLAGS "$COMMON_LINKER_FLAGS")
set(CMAKE_LINKER_TYPE LLD)
set(CMAKE_C_COMPILER clang)
set(CMAKE_CXX_COMPILER clang++)
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
EOF
	LLVM_DIST=${target_root_with_pkgname}
	LLVM_RES_DIR=${LLVM_DIST}/lib/clang/21

local COMP_FLAGS="-DCMAKE_BUILD_TYPE=Release \
-DCMAKE_INSTALL_PREFIX=${LLVM_DIST} \
-DCMAKE_VERBOSE_MAKEFILE=ON \
-DHAVE_THREAD_SAFETY_ATTRIBUTES=0 \
-DHAVE_POSIX_REGEX=0 \
-DHAVE_STEADY_CLOCK=0"
	
local CONF_FLAGS="-DLIBCXX_HAS_MUSL_LIBC=ON \
-DCOMPILER_RT_BUILD_GWP_ASAN=OFF \
-DLIBOMP_OMPD_GDB_SUPPORT=OFF \
-DLLVM_NATIVE_TOOL_DIR=/usr/bin \
-DCROSS_TOOLCHAIN_FLAGS_NATIVE=\"-DLLVM_NATIVE_TOOL_DIR=/usr/bin;-DCMAKE_SYSROOT=/usr;-DLLVM_DEFAULT_TARGET_TRIPLE=${BUILD_PLATFORM_TRIPLET}\" \
-DLLVM_HOST_TRIPLE=${TARGET} \
-DCOMPILER_RT_DEFAULT_TARGET_TRIPLE=${TARGET} \
-DCOMPILER_RT_USE_BUILTINS_LIBRARY=ON \
"
	pushd ${current_source_root}

	local LLVM_LIBSUFFIX="${OHOS_LIBDIR#*/}"
	local LLVM_EXTFLAG=""
	if [ ! $LLVM_LIBSUFFIX == "$OHOS_LIBDIR" ]]; then
		LLVM_EXTFLAG="-DLLVM_LIBDIR_SUFFIX=/${LLVM_LIBSUFFIX}"
	fi
	$CMAKE_BIN \
		${COMP_FLAGS} \
		-DCMAKE_INSTALL_LIBDIR=${OHOS_LIBDIR} \
		-DCMAKE_INSTALL_PACKAGEDIR=${OHOS_LIBDIR}/cmake \
		${LLVM_EXTFLAG} \
		-DLLVM_ENABLE_PROJECTS="lld;clang" \
		-DCMAKE_TOOLCHAIN_FILE=${current_source_root}/$TARGET-clang.cmake \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-DLLVM_HOST_TRIPLE=$TARGET \
		-S llvm \
		-B ohos-build
	
	$CMAKE_BIN --build ohos-build -- -j20
	$CMAKE_BIN --install ohos-build

	# native build
	$CMAKE_BIN \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_VERBOSE_MAKEFILE=ON \
		-DLLVM_ENABLE_PROJECTS="lld;clang" \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-S llvm \
		-B native-build
	$CMAKE_BIN --build native-build -- -j20

	popd

	_custom_build_continue=false
}

# Hook: called after leaving build dir (staging area ${target_root_with_pkgname} is generated)
postbuilt_hook() {
	# create symlink for llvm-config
	info "creating symlinks for libLLVM (required by llvm-config)"
	local LLVM_CONFIG_SHARED_SO=libLLVM-21.so
	pushd ${target_root_with_pkgname}/${OHOS_LIBDIR}
	if [ ! -f $LLVM_CONFIG_SHARED_SO ]; then
		ln -s libLLVM.so.21.1 $LLVM_CONFIG_SHARED_SO
	fi
	popd
	pushd ${current_source_root}/native-build/lib
	if [ ! -f $LLVM_CONFIG_SHARED_SO ]; then
		ln -s libLLVM.so.21.1 $LLVM_CONFIG_SHARED_SO
	fi
	popd

	# copy necessary native binaries for llvm-config
	cp -r ${current_source_root}/native-build/{lib,bin,libexec} ${native_project_root}/llvm-config-wrapper

	# build llvm-config-wrapper
	info "building CXX object llvm-config (cross compile) for native platform"
	local LLVM_CONFIG_WRAPPER_SRC=${native_project_root}/llvm-config-wrapper/llvm-config-wrapper.cpp
	sed -i -e "s|\(static const std::string NATIVE_LLVM_CONFIG = \).*|\1\"${native_project_root}/llvm-config-wrapper/bin/llvm-config\";|" \
		-e "s|\(static const std::string TARGET_LLVM_PREFIX = \).*|\1\"${target_root_with_pkgname}\";|" \
		-e "s|\(static const std::string OHOS_LIBDIR = \).*|\1\"${OHOS_LIBDIR}\";|" \
		-e "s|\(static const std::string OHOS_CPU = \).*|\1\"${OHOS_CPU}\";|" \
		${LLVM_CONFIG_WRAPPER_SRC}
	g++ -std=c++17 ${LLVM_CONFIG_WRAPPER_SRC} -o ${native_project_root}/llvm-config-wrapper/llvm-config
}

################ self-defined functions (local) goes below ################
