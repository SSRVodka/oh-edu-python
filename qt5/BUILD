#!/bin/bash
set -Eeuo pipefail

# NOTE: adding / removing the variables / modifying the name of variables is not allowed in this script

# Available local variables:
#  - variables defined in custom_build
#  - ${target_root_prefix_without_pkgname}: ${target_root_with_pkgname} is the output directory generated by the building process. i.e. the staging area for this package manager. Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#  - ${sources_root}: the suggested root directory of the source directory
setup() {

# TODO: please fill in the variables for this package

# [REQUIRED, NON-EMPTY, SEMVER]
pkg_version="5.15.12"
# [REQUIRED, NON-EMPTY, NO-SPACE]
pkg_name="qt5"
# [OPTIONAL, seperated by commas, NO-SPACE]. e.g., pkgname1>=0.5,pkgname2==1.0.0,pkgname2<2.0.0,pkgname3
pkg_deps=""
# [OPTIONAL, seperated by commas, NO-SPACE]
pkg_build_deps=""
########### At Least ONE is REQUIRED ##############
# [OPTIONAL, VALID-URL]
pkg_source_url="https://gitcode.com/qtforohos/qt5.git"
# [OPTIONAL, VALID-URL]
pkg_release_url=""
###################################################
pkg_license="Apache-2.0"
# [REQUIRED, NON-EMPTY, seperated by commas, NO-SPACE]. e.g., x86_64,aarch64,arm,riscv
pkg_support_archs="x86_64,aarch64,arm"
# [REQUIED, NON-EMPTY]
# choose one: "autotools" (configure and make), "cmake", "meson", "pure-python", "custom"
# NOTE:
#  - "pure-python" is ONLY valid for those packages without ANY native package dependency.
#  - "custom" will skip the default build process
pkg_build_type="custom"
# [OPTIONAL]
pkg_build_parallism=""

####### build type related (all OPTIONAL) #######

pkg_build_autotools_extra_configure_flags=""
# fill in a relative path to the ${current_source_root} (defined below)
pkg_build_autotools_bootstrap_script=""
pkg_build_autotools_suffix_configure_flags=""
pkg_build_autotools_configure_dir=""

pkg_build_cmake_extra_cmake_flags=""
pkg_build_cmake_extra_cmake_prefix_path=""
pkg_build_cmake_extra_cflags=""
# NOTE: C preprocessor not CXX
pkg_build_cmake_extra_cppflags=""
pkg_build_cmake_extra_ldflags=""
pkg_build_cmake_extra_cmake_findroot_path=""

# fill in a absolute path
pkg_build_meson_cross_file=""
pkg_build_meson_extra_meson_flags=""
pkg_build_meson_extra_cflags=""
pkg_build_meson_extra_ldflags=""
pkg_build_meson_extra_cmake_prefix_path=""
pkg_build_meson_extra_cmake_findroot_path=""

}


################# Hooks #################
# NOTE:
#  1. not using relative path in hooks
#  2. not using $PWD, pwd, cd here. You can ONLY use pushd to change your working directory and you are responsible to use popd to restore the old one before the hook returns
#  3. not creating global variables in hooks (except for `custom_build`)
#  4. global config variables (capitalized) in setup.sh (like OHOS_LIBDIR, OHOS_CPU, ...) is available in hooks
#  5. important cross-compiling variables will be reset after building each package (like CFLAGS, CXXFLAGS, LDFLAGS, CC, CXX, AR, PKG_CONFIG_LIBDIR, ...)
#  6. you can use helper functions in setup.sh
#  7. you can define your own function here but you can only use it for this package. If you want to define a function for building process of multiple packages, you should modify the setup.sh
#  8. you are responsible to handle all the failures in hooks (commands may continue if you not deal with it)
# 
# Available global variables:
#  - ${native_project_root}: the parent directory of setup.sh
#  - ${native_sources_root}: root for native sources (staging area)
#  - cross-compiling variables (reset for each package): CC, CXX, AR, CFLAGS, PKG_CONFIG_*, ...
#  - global configurations: OHOS_ARCH, OHOS_CPU, OHOS_LIBDIR, PATCH_FILE_ROOT, MESON_CROSS_ROOT, HOST_SYSROOT, ... (see setup.sh)
# Available local variables (except for native_env_hook):
#  - ${current_source_url}: user configured `pkg_source_url` above (in `setup()`)
#  - ${current}: the location (directory) of this script
#  - ${sources_root}: the suggested root directory of the source directory
#  - ${current_source_root}: the current source directory to be compiled
#  - ${target_root_with_pkgname}: output directory generated by the building process. i.e. the staging area for this package manager
#  - ${target_root_prefix_without_pkgname}: Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#########################################

# Hook: called before setup.sh is sourced
# NOTE:
#  - failure in this function will terminate this script immediately
#  - you can NOT use local variables defined above. you can only use ${native_project_root}, ${native_sources_root} built by builder.sh
native_env_hook() {
	:
}

# Hook: customize downloading source process. called when pacakge manager is downloading the source.
# 	Set _custom_download_source_continue to "true" (default) to continue normal downloading process after return, otherwise not.
# NOTE: you need to make sure the source locates in ${current_source_root}
# 	if you set _custom_download_source_continue="false" caz default build process will use
custom_download_source() {

	if [ ! -f "${current_source_root}/QT5_DOWNLOADED" ]; then
		# rm -rf ${current_source_root}
		mkdir -p ${current_source_root}
		git clone -b v5.15.12-lts-lgpl --recurse-submodules --single-branch --shallow-submodules https://gitcode.com/qtforohos/qt5.git ${current_source_root}/qt5-ohos
		git clone -b Alpha_v7 https://gitcode.com/openharmony-sig/qt.git ${current_source_root}/qt-ohos-patches

		touch ${current_source_root}/QT5_DOWNLOADED
	fi

	_custom_download_source_continue=false
}

############### DO NOT MODIFY THIS PART #################
if [ "x${LOAD_NATIVE_HOOK_ONLY:-}" = "xtrue" ]; then
	return 0
fi
#########################################################

# Hook: called before entering build dir
prebuilt_patch_hook() {
	:
}

# Hook: same as `prebuilt_patch_hook` but executed once if the source directory is not changed (mark file PATCHED)
# NOTE: it will be executed BEFORE prebuilt_patch_hook
prebuilt_patch_once_hook() {
	:
}

# Hook: customize building process.
# 	Set _custom_build_continue to "true" (default) to continue normal building process after return, otherwise not.
# NOTE:
#  - You can set cross-compiling related global variables here (like CFLAGS)
#  - postbuilt_hook will still be called after custom_build set _custom_build_continue="false"
custom_build() {

	# qmake.conf use x86-64 instead of x86_64
	local qt_arch=${OHOS_ARCH}
	if [ "$OHOS_ARCH" == "x86_64" ]; then
		qt_arch="x86-64"
	fi

	# fuck OpenHarmony API
	ver_cmp=$(compare_versions "${OHOS_SDK_API_VERSION}" "15")
	if [ $ver_cmp == -1 ]; then
		error "Qt5 only support OHOS API greater then 15"
		return 1
	fi

	# apply patches
	local QT_VERSION=v${pkg_version}
	local src_dir=${current_source_root}/qt5-ohos
	local patch_dir=${current_source_root}/qt-ohos-patches/patch/${QT_VERSION}
	if [ ! -d $src_dir ]; then
		error "cannot find Qt source directory"
		return 1
	fi
	if [ ! -d $patch_dir ]; then
		error "cannot find ohos patch for Qt ${QT_VERSION}"
		return 1
	fi
	
	# patch mark
	if [ ! -f $src_dir/patched ]; then
	
	local ptch_cnt=0
	for ptch in $patch_dir/*.patch; do
		bn=$(basename $ptch)
		if [ $bn == "root.patch" ]; then
			git -C ${src_dir} apply $ptch
		else
			module_name=$(echo $bn | awk -F'.' '{print $1}')
			module_path=$src_dir/${module_name}
			git -C ${module_path} apply $ptch
		fi
		ptch_cnt=$[ptch_cnt+1]
	done
	
	if [ $ptch_cnt -eq 0 ]; then
		error "no patch file in $patch_dir"
		exit 1
	fi
	info "applied $ptch_cnt patch(es) to Qt ${QT_VERSION}"
	
	# oh extra module
	local oh_extra_dir=$patch_dir/qtohextras
	local oh_extra_dest=$src_dir/qtohextras
	if [ ! -d $oh_extra_dir ]; then
		warn "OH extra module for Qt ${QT_VERSION} not found"
	else
		if [ -d $oh_extra_dest ]; then
			rm -rf $oh_extra_dest
		fi
		cp -r $oh_extra_dir $oh_extra_dest
		# create git submodule mark
		echo "gitdir: ../.git/modules/qtohextras" > $oh_extra_dest/.git
	fi
	info "added extra OH module for Qt $QT_VERSION"
	
	touch $src_dir/patched
	
	fi

	pushd ${current_source_root}/qt5-ohos

	# patch for UNIX path
	# sed -i "s|^\(#include <multimodalinput\)\\\(oh_input_manager.h>\)|\1/\2|" qtbase/src/plugins/platforms/openharmony/qohkeys.h
	sed -i "s|^\(#include <multimodalinput\)\\\\\(.*\)|\1/\2|" qtbase/src/plugins/platforms/openharmony/qohkeys.h

	mkdir -p ohos-build.${OHOS_CPU}
	pushd ohos-build.${OHOS_CPU}
	
	local flags=(
	  -opensource
	  -confirm-license
	  -platform linux-g++
	  -xplatform oh-clang
	  -opengl es2
	  -opengles3
	  -no-dbus
	  -openssl-runtime "OPENSSL_INCDIR=$(get_pkg_dst_dir openssl)/include"
	  -disable-rpath
	  -nomake tests
	  -nomake examples
	  -skip qtpim
	  -skip qtvirtualkeyboard
	  -skip qtwebengine
	  -skip qtsystems
	  -skip qtlocation
	  -skip qtgamepad
	  -skip qtscript
	  -skip qtwebview
	  -prefix "${target_root_with_pkgname}"
	  -release
	  -device-option "OHOS_ARCH=${qt_arch}"
	  -make-tool "make -j20"
	  -feature-ipc_posix
	  -verbose
	)
	# mv build python
	export LD_LIBRARY_PATH=${BUILD_PYTHON_DIST}/lib:$LD_LIBRARY_PATH
	local _sdk_buildpy=${OHOS_SDK}/native/llvm/bin/python
	mv ${_sdk_buildpy}{,.lock}
	ln -s ${BUILD_PYTHON} ${_sdk_buildpy}
	
	export OHOS_SDK_PATH=$OHOS_SDK
	../configure "${flags[@]}" || { error "qt5 configure failed"; rm ${_sdk_buildpy}; mv ${_sdk_buildpy}{.lock,}; popd; popd; return 1; }
	
	make -j20 || { error "qt5 make failed"; rm ${_sdk_buildpy}; mv ${_sdk_buildpy}{.lock,}; popd; popd; return 1; }
	make install || { error "qt5 install failed"; rm ${_sdk_buildpy}; mv ${_sdk_buildpy}{.lock,}; popd; popd; return 1; }
	
	# restore build python
	rm ${OHOS_SDK}/native/llvm/bin/python
	mv ${OHOS_SDK}/native/llvm/bin/python{.lock,}

	popd
	popd

	_custom_build_continue=false
}

# Hook: called after leaving build dir (staging area ${target_root_with_pkgname} is generated)
postbuilt_hook() {
	# copy dependencies: openssl
	cp $(get_pkg_dst_dir openssl)/${OHOS_LIBDIR}/{libcrypto.so*,libssl.so*} ${target_root_with_pkgname}/${OHOS_LIBDIR}
}

################ self-defined functions (local) goes below ################
