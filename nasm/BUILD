#!/bin/bash
set -Eeuo pipefail

# NOTE: adding / removing the variables / modifying the name of variables is not allowed in this script

# Available local variables:
#  - variables defined in custom_build
#  - ${target_root_prefix_without_pkgname}: ${target_root_with_pkgname} is the output directory generated by the building process. i.e. the staging area for this package manager. Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#  - ${sources_root}: the suggested root directory of the source directory
setup() {

# TODO: please fill in the variables for this package

# [REQUIRED, NON-EMPTY, SEMVER]
pkg_version="3.1"
# [REQUIRED, NON-EMPTY, NO-SPACE]
pkg_name="nasm"
# [OPTIONAL, seperated by commas, NO-SPACE]. e.g., pkgname1>=0.5,pkgname2==1.0.0,pkgname2<2.0.0,pkgname3
pkg_deps=""
# [OPTIONAL, seperated by commas, NO-SPACE]
pkg_build_deps=""
########### At Least ONE is REQUIRED ##############
# [OPTIONAL, VALID-URL]
pkg_source_url="https://github.com/netwide-assembler/nasm/archive/refs/tags/nasm-3.01.zip"
# [OPTIONAL, VALID-URL]
pkg_release_url=""
###################################################
pkg_license="Apache-2.0"
# [REQUIRED, NON-EMPTY, seperated by commas, NO-SPACE]. e.g., x86_64,aarch64,arm,riscv
pkg_support_archs="x86_64,aarch64,arm"
# [REQUIED, NON-EMPTY]
# choose one: "autotools" (configure and make), "cmake", "meson", "pure-python", "custom"
# NOTE:
#  - "pure-python" is ONLY valid for those packages without ANY native package dependency.
#  - "custom" will skip the default build process
pkg_build_type="autotools"
# [OPTIONAL]
pkg_build_parallism=""

####### build type related (all OPTIONAL) #######

pkg_build_autotools_extra_configure_flags=""
# fill in a relative path to the ${current_source_root} (defined below)
pkg_build_autotools_bootstrap_script="./autogen.sh"
pkg_build_autotools_suffix_configure_flags=""
pkg_build_autotools_configure_dir=""

pkg_build_cmake_extra_cmake_flags=""
pkg_build_cmake_extra_cmake_prefix_path=""
pkg_build_cmake_extra_cflags=""
# NOTE: C preprocessor not CXX
pkg_build_cmake_extra_cppflags=""
pkg_build_cmake_extra_ldflags=""
pkg_build_cmake_extra_cmake_findroot_path=""

# fill in a relative path to this script
pkg_build_meson_cross_file=""
pkg_build_meson_extra_meson_flags=""
pkg_build_meson_extra_cflags=""
pkg_build_meson_extra_ldflags=""
pkg_build_meson_extra_cmake_prefix_path=""
pkg_build_meson_extra_cmake_findroot_path=""

}


################# Hooks #################
# NOTE:
#  1. not using relative path in hooks
#  2. not using $PWD, pwd, cd here. You can ONLY use pushd to change your working directory and you are responsible to use popd to restore the old one before the hook returns
#  3. not creating global variables in hooks (except for `custom_build`)
#  4. global config variables (capitalized) in setup.sh (like OHOS_LIBDIR, OHOS_CPU, ...) is available in hooks
#  5. important cross-compiling variables will be reset after building each package (like CFLAGS, CXXFLAGS, LDFLAGS, CC, CXX, AR, PKG_CONFIG_LIBDIR, ...)
#  6. you can use helper functions in setup.sh
#  7. you can define your own function here but you can only use it for this package. If you want to define a function for building process of multiple packages, you should modify the setup.sh
#  8. you are responsible to handle all the failures in hooks (commands may continue if you not deal with it)
# 
# Available global variables:
#  - ${native_project_root}: the parent directory of setup.sh
#  - ${native_sources_root}: root for native sources (staging area)
#  - cross-compiling variables (reset for each package): CC, CXX, AR, CFLAGS, PKG_CONFIG_*, ...
#  - global configurations: OHOS_ARCH, OHOS_CPU, OHOS_LIBDIR, PATCH_FILE_ROOT, MESON_CROSS_ROOT, HOST_SYSROOT, ... (see setup.sh)
# Available local variables (except for native_env_hook):
#  - ${current_source_url}: user configured `pkg_source_url` above (in `setup()`)
#  - ${current}: the location (directory) of this script
#  - ${sources_root}: the suggested root directory of the source directory
#  - ${current_source_root}: the current source directory to be compiled
#  - ${target_root_with_pkgname}: output directory generated by the building process. i.e. the staging area for this package manager
#  - ${target_root_prefix_without_pkgname}: Now ${target_root_prefix_without_pkgname}.<pkgname> == ${target_root_with_pkgname}
#########################################

# Hook: called before setup.sh is sourced
# NOTE:
#  - failure in this function will terminate this script immediately
#  - you can NOT use local variables defined above. you can only use ${native_project_root}, ${native_sources_root} built by builder.sh
native_env_hook() {
	:
}

# Hook: customize downloading source process. called when pacakge manager is downloading the source.
# 	Set _custom_download_source_continue to "true" (default) to continue normal downloading process after return, otherwise not.
# NOTE: you need to make sure the source locates in ${current_source_root}
# 	if you set _custom_download_source_continue="false" caz default build process will use
custom_download_source() {
	_custom_download_source_continue=true
}

############### DO NOT MODIFY THIS PART #################
if [ "x${LOAD_NATIVE_HOOK_ONLY:-}" = "xtrue" ]; then
	return 0
fi
#########################################################

# Hook: called before entering build dir
prebuilt_patch_hook() {
	# make nasm configure happy 
	if [ ! -f "${current_source_root}/nasm.1" ]; then
		touch ${current_source_root}/nasm.1 ${current_source_root}/ndisasm.1
	fi
}

# Hook: same as `prebuilt_patch_hook` but executed once if the source directory is not changed (mark file PATCHED)
# NOTE: it will be executed BEFORE prebuilt_patch_hook
prebuilt_patch_once_hook() {
	:
}

# Hook: customize building process.
# 	Set _custom_build_continue to "true" (default) to continue normal building process after return, otherwise not.
# NOTE:
#  - You can set cross-compiling related global variables here (like CFLAGS)
#  - postbuilt_hook will still be called after custom_build set _custom_build_continue="false"
custom_build() {
	_custom_build_continue=true
}

# Hook: called after leaving build dir (staging area ${target_root_with_pkgname} is generated)
postbuilt_hook() {
	:
}

################ self-defined functions (local) goes below ################
